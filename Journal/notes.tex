\documentclass{article}
\input{../math_commands}
\input{../custom_imports}
\usepackage[margin=54pt]{geometry}
\usepackage{biblatex}
\addbibresource{../biblio.bib}


\begin{document}

\date{}
\author{Marco Sterlini}

\title{Journal}
\maketitle

Ordered list of problems and steps taken to solve them, or at least to understand them better.

\section*{Initial works}

The first weeks were spent understanding the papers and the Matlab code given by Sophie (\cite{automatica}, \cite{css-paper}, \cite{data-driven}) regarding the application of ETM to the NN controller of a linearized and non linearized pendulum. The aim is to save as much computational load as possible by putting ETM in between the layers. Doing so it is possible to decide whether propagating the current layer output to the activation function. 
The main computational save will regard directly the application of the activation function that, being non-linear, is the most expensive operation in the network.
Some sum ups can be found in the folders \textit{"Automatica paper discussion", "Dynamic ETM intro discussion", "Sector conditions intro discussion"}.

\subsection*{Faulty application of global sector conditions}

I tried to apply directly the proposition of Sophie's notes to the system portrayed in \cite{css-paper}. Everything is documented in the notes \textit{"Faulty implementation of dynamic ETM report"} in \textit{"extra material"} folder.

\section*{Reproducing the results of the papers}

A first attempt into the implementation has been portrayed in Matlab and immediately after in Python. The most used modules were \texttt{cvxpy} as a framework for LMI resolution and \texttt{NumPy} for generic mathematical manipulation. 

\subsection*{Linear Inverted Pendulum}
The system used in \cite{css-paper} has been implemented in Python. The same weights used in the paper have been used to build up the NN controller. The main module exploited is \texttt{PyTorch}, the activation functions used are saturations. Tweaking the LMI conditions I was able to obtain the same results of the paper with the same basins of attraction.
The main concern about the approach followed in the paper regards the ETM mechanism design:
$$
  \hat{\omega}^{i}(k) = \begin{cases}
    \omega^{i}(k) & \text{if } f^{i}(\omega^{i}(k), \hat{\omega}^{i}(k-1), \hat{\omega}^{i-1}(k)) \geq 0\\
    \hat{\omega}^{i}(k-1) & \text{otherwise}  
  \end{cases}
$$
Where 
$$ 
f^{i}(\omega^{i}(k), \hat{\omega}^{i}(k-1), \hat{\omega}^{i-1}(k)) = ||\hat{\omega}^{i}(k-1) - \omega^{i}(k)||^{2}_{q^{i}_{\Delta}} - ||\omega^{i}(k) - \omega^{i}_*||^{2}_{q^{i}_{\omega}} - ||\hat{\omega}^{i-1}(k) - \omega^{i-1}_*||^{2}_{q^{i-1}_{\hat{\omega}}}
$$
The good thing about this function is the capability to stop early the computation and avoid computing the remaining layer if one doesn't trigger. However, this capability looses meaning when applied to a 2 layer NN controller. The bad point lies instead in the term $\omega^{i}(k) = sat(\nu^{i}(k))$ that is required at each layer verification. The need to compute this term, hence computing the activation function, makes the ETM useless if not for the cascade effect that remains good but not enough to be worth the computational load.

Nevertheless, I was able to reproduce the results for the static ETM, and I was able to extend the problem to a dynamic ETM inspired by the work of \cite{data-driven}.

\section*{Adding the conditions for dynamic ETM}
The main logic was to update the data used to compute the new input to the system only when necessary:
$$
  \pmx{\chi \\ s} = \begin{cases}
    \pmx{\omega\\ k} & \text{if the memory is updated}\\ 
    \pmx{\chi_{k-1} \\ s_{k-1}} & \text{otherwise}
  \end{cases}
$$

With the ETM mechanism described as follows:

$$
s^{+} = \text{min}_{m \in \NN} \left\{ m \geq s + 1 | \psi(\omega_m, \chi) \geq \rho \eta_m \right\}
$$

And $\eta$ dynamic is defined as:

$$
  \eta^{+} = (\rho + \lambda) \eta - \psi(\omega_m, \chi)
$$

This formulation ensures $\eta$ to be always positive and made it possible to consider it as a positive system like in \cite{positive-systems}. 
As a quick proof I can say that if the triggering condition $\psi$ is negative then the positiveness of $\eta$ is trivial. If instead $\psi$ is positive and $\psi \geq \rho \eta $

\section*{Problem in the extension to custom trained NN controllers}

\section*{Idea to use Samuele's results to address robustness of a NN controlled system with integrator in DT}

\section*{Development of new controllers}

\subsection*{Reinforcement learning approach}

\subsection*{Deep learning approach of LQR controller} 

\section*{Problems in the addition of system non-linearities} 

\subsection*{Progressive simplification of the problem to understand the issue}

\subsection*{1 layer saturation controller to linear pendulum}

It works by putting $\alpha = 1$

\subsection*{1 layer saturation controller to linear pendulum with integrator in the state}

It works by putting $\alpha = 1$

\subsection*{Attempt on handcrafting NN}
Considerations on it can be found in the last subsection of \textit{"Linear integrator 1 dimension case"}.
I am now trying to train a 3-layer NN with deep learning method on a K matrix found with LQR method and not pole placement. It will then be attempted to:
\begin{itemize}
  \item Find a LMI solution for the system with integrator and non-linearity for the 3 layer network. If it doesn't work simplify the problem and add complexity bit by bit
  \item Test the K gain from LQR method to non-linear system with and without saturation
  \item Find the LMI solution for the non-linear system with input saturation: $u = sat(K_{LQR} \cdot x)$
\end{itemize}

\subsection*{1 layer saturation controller to non-linear pendulum with integrator in the state}
The system under analysis is represented by the dynamic:

$$
m l^{2} \ddot{\theta} = m g l\ sin(\theta) - \mu \dot{\theta} + u
$$

That discretized becomes:

$$
  \begin{cases}
    \theta^{+} = \theta + \dot{\theta} \delta t\\
    \dot{\theta}^{+} = \dot{\theta} + \ddot{\theta} \delta t = \dot{\theta} + (\frac{g}{l} sin(\theta) - \frac{\mu}{m l^{2}} \dot{\theta}) \delta t + \frac{dt}{m l^{2} u} \\
    \eta^{+} = \eta + y = \eta + (\theta - r)
  \end{cases}
$$

I want to deal with the non-linearity in the form of $sin(\theta) - \theta$. In order to do so, I add and subtract the term $\frac{g}{l} \cdot dt \cdot \theta$ to $\dot{\theta}$ dynamics. Then by expressing $\phi(\theta) = sin(\theta) - \theta$ I can rewrite the overall dynamics as:

\begin{equation}
  \bmx{
    \theta^{+} \\
    \dot{\theta}^{+} \\
    \eta^{+}
  } = \bmx{
    1 & \delta t & 0 \\
    \frac{g \cdot dt}{l} & 1 - \frac{\mu \cdot dt}{m l^{2}} & 0 \\
    1 & 0 & 1
  } \bmx{
    \theta \\
    \dot{\theta} \\
    \eta
  } + \bmx{
    0 \\
    \frac{dt}{m l^{2}} \\
    0
  } u + \bmx{
    0 \\
    \frac{g \cdot dt}{l} \\
    0 
  } \phi 
\end{equation}

With more condensed notation:
$$
  x^{+} = A x + B u + C \phi
$$

The sector conditions on the saturation are the same of \cite{css-extended} adapted for the single saturation case:
$$
N = \bmx{
\begin{array}{c|c|c}
  0 & 1 & 0 \\
  \hline
  K & 0 & 0
\end{array}
}
$$

Each element is null except for $N_{u \omega} = 1$ and $N_{\nu x} = K$ so to have:
\begin{align*}
  \nu &= N_{\nu x} \cdot x + N_{\nu \omega} \cdot \omega + N_{\nu b} = K x\\
  u &= N_{ux} \cdot x + N_{u \omega} \cdot \omega + N_{u b} = \omega = sat(\nu)
\end{align*}

In the end the control input is $u = sat(\nu) = sat(K x)$

I consider a quadratic Lyapunov function $V = \tilde{x}\tr P \tilde{x}$ and I want to bound $\Delta V$ to be strictly negative.

\pagebreak
\emergencystretch=2em % To account for hbox overflow warning
\printbibliography

\end{document}